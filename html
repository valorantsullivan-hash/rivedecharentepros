<!DOCTYPE html>
<html lang="fr" manifest="manifest.appcache">
<head>
<meta charset="UTF-8">
<title>Rive de Charente – Avec Notifications Push</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#2563eb">
<link rel="manifest" href="data:application/manifest+json,{
  \"name\":\"Rive de Charente\",
  \"short_name\":\"RiveCharente\",
  \"start_url\":\".\",
  \"display\":\"standalone\",
  \"background_color\":\"#ffffff\",
  \"theme_color\":\"#2563eb\",
  \"icons\":[{\"src\":\"https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f4cc.png\",\"sizes\":\"72x72\",\"type\":\"image/png\"}]
}">
<style>
  :root{--p:#2563eb;--s:#1e40af;--g:#10b981;--r:#ef4444;--l:#f8fafc;--d:#1e293b;}
  *{margin:0;padding:0;box-sizing:border-box;font-family:system-ui,sans-serif;}
  body{background:var(--l);color:var(--d);min-height:100vh;padding:10px;}
  .card{max-width:460px;margin:20px auto;background:white;border-radius:20px;box-shadow:0 20px 50px rgba(0,0,0,0.15);overflow:hidden;}
  header{background:linear-gradient(135deg,var(--p),var(--s));color:white;padding:50px 30px;text-align:center;}
  h1{font-size:34px;margin-bottom:8px;}
  .content{padding:30px;}
  input,button{width:100%;padding:15px;margin:10px 0;border-radius:12px;font-size:16px;}
  input{border:1px solid #ddd;background:#f9fafb;}
  button{background:var(--p);color:white;border:none;cursor:pointer;font-weight:600;}
  button:hover{opacity:0.9;}
  .link{color:var(--p);cursor:pointer;}
  .hidden{display:none;}
  .notif-btn{background:var(--g);margin-top:15px;}
  .dashboard{max-width:1100px;margin:0 auto;display:grid;gap:25px;}
  .panel{background:white;padding:30px;border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,0.1);}
  .calendar table{width:100%;border-collapse:collapse;}
  .calendar th,.calendar td{padding:12px;text-align:center;border:1px solid #e2e8f0;}
  .calendar td{height:100px;vertical-align:top;cursor:pointer;position:relative;}
  .calendar td:hover{background:#eff6ff;}
  .day-num{font-weight:bold;font-size:19px;}
  .event{padding:5px 9px;margin:3px 0;border-radius:8px;color:white;font-size:13px;overflow:hidden;text-overflow:ellipsis;}
  .me{background:var(--p);}
  .other{background:var(--g);}
  .official{background:var(--r);font-weight:bold;}
  .del{float:right;cursor:pointer;font-weight:bold;}
  @media(max-width:640px){.calendar td{height:75px;font-size:13px;}}
</style>
</head>
<body>

<div id="app">
  <!-- AUTH -->
  <div id="auth" class="card">
    <header>
      <h1>Rive de Charente</h1>
      <p>Association & Bénévoles</p>
    </header>
    <div class="content">
      <div id="loginForm">
        <h2>Connexion</h2>
        <input type="email" id="loginEmail" placeholder="Email">
        <input type="password" id="loginPass" placeholder="Mot de passe">
        <button onclick="login()">Se connecter</button>
        <p class="link" onclick="showRegister()">Créer un compte →</p>
        <p id="loginError" style="color:var(--r);margin-top:10px;"></p>
      </div>

      <div id="registerForm" class="hidden">
        <h2>Inscription</h2>
        <input type="text" id="regName" placeholder="Prénom">
        <input type="email" id="regEmail" placeholder="Email">
        <input type="password" id="regPass" placeholder="Mot de passe (min 6)">
        <button onclick="register()">S'inscrire</button>
        <p class="link" onclick="showLogin()">← Retour connexion</p>
        <p id="regSuccess" class="success"></p>
        <p id="regError" style="color:var(--r);"></p>
      </div>
    </div>
  </div>

  <!-- DASHBOARD -->
  <div id="dashboard" class="hidden dashboard">
    <div class="panel">
      <button style="background:var(--r);float:right;" onclick="logout()">Déconnexion</button>
      <h2 id="welcomeText"></h2>
      <button class="notif-btn" onclick="requestNotificationPermission()">Activer les notifications push</button>

      <div class="calendar">
        <h3 id="monthTitle" style="text-align:center;margin:30px 0 15px;font-size:26px;"></h3>
        <table><thead><tr><th>Dim</th><th>Lun</th><th>Mar</th><th>Mer</th><th>Jeu</th><th>Ven</th><th>Sam</th></tr></thead>
        <tbody id="calBody"></tbody></table>
      </div>

      <div id="quick" class="hidden panel" style="margin-top:25px;">
        <h3>Dispo le <span id="selDate"></span></h3>
        <input type="time" id="qTime">
        <input type="text" id="qDesc" placeholder="Ex : stand marché 14h-18h">
        <button onclick="saveDispo()">Enregistrer</button>
        <button onclick="hideQuick()" style="background:#64748b;">Annuler</button>
      </div>

      <div id="adminPanel" class="hidden panel" style="margin-top:30px;background:#fef3c7;">
        <h3 style="color:#d97706;">Admin – Nouvel événement</h3>
        <input type="text" id="eName" placeholder="Nom de l'événement">
        <input type="date" id="eDate">
        <input type="text" id="eLieu" placeholder="Lieu">
        <button onclick="addOfficialEvent()">Créer + Notifier tout le monde</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<script>
// ==== SERVICE WORKER + NOTIFICATIONS PUSH (sans serveur !) ====
if ('serviceWorker' in navigator && 'PushManager' in window) {
  navigator.serviceWorker.register('data:application/javascript,' + encodeURIComponent(`
    self.addEventListener('push', event => {
      const data = event.data ? event.data.json() : {title: "Rive de Charente", body: "Nouvelle activité !"};
      self.registration.showNotification(data.title, {body: data.body, icon: "https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f4cc.png"});
    });
  `))
  .then(reg => console.log('SW enregistré pour notifications simulées))
  .catch(err => console.log('SW non supporté sur ce navigateur'));
}

// Fonction d'envoi de notification (simulée mais fonctionne sur tous les navigateurs modernes)
function sendNotification(title, body) {
  if (Notification.permission === "granted") {
    new Notification(title, {
      body: body,
      icon: "https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f4cc.png",
      badge: "https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f4cc.png"
    });
  }
}

// Demander la permission
function requestNotificationPermission() {
  if ('Notification' in window && Notification.permission === "default") {
    Notification.requestPermission().then(perm => {
      if (perm === "granted") alert("Notifications activées !");
    });
  }
}

// ==== BASE DE DONNÉES LOCAL ====
const db = {
  get(k) { return JSON.parse(localStorage.getItem(k) || 'null'); },
  set(k, v) { localStorage.setItem(k, JSON.stringify(v)); }
};

const ADMIN_PASS_HASH = "a665a45920422f9d417e4867efdc4fb8a04a1f3fff1fa07e998e86f7f7a27ae3"; // = "123" en SHA-256 (change-le si tu veux)

let currentUser = null;
let selectedDate = null;

// ==== AUTH ====
function showLogin(){ document.getElementById('registerForm').classList.add('hidden'); document.getElementById('loginForm').classList.remove('hidden'); }
function showRegister(){ document.getElementById('loginForm').classList.add('hidden'); document.getElementById('registerForm').classList.remove('hidden'); }

function register() {
  const name = document.getElementById('regName').value.trim();
  const email = document.getElementById('regEmail').value.toLowerCase().trim();
  const pass = document.getElementById('regPass').value;
  if (pass.length < 6) return document.getElementById('regError').textContent = "Mot de passe ≥ 6 caractères";

  let users = db.get('users') || {};
  if (users[email]) return document.getElementById('regError').textContent = "Email déjà pris";

  users[email] = { name, passHash: CryptoJS.SHA256(pass).toString(), role: 'volunteer' };
  db.set('users', users);
  document.getElementById('regSuccess').textContent = "Compte créé !";
  setTimeout(showLogin, 1500);
}

function login() {
  const email = document.getElementById('loginEmail').value.toLowerCase().trim();
  const pass = document.getElementById('loginPass').value;
  const users = db.get('users') || {};

  const user = users[email];
  if (user && user.passHash === CryptoJS.SHA256(pass).toString()) {
    currentUser = { email, name: user.name, role: user.role };
    if (CryptoJS.SHA256(pass).toString() === ADMIN_PASS_HASH) currentUser.role = 'admin';
    enterApp();
  } else {
    document.getElementById('loginError').textContent = "Mauvais identifiants";
  }
}

function logout() {
  currentUser = null;
  document.getElementById('auth').classList.remove('hidden');
  document.getElementById('dashboard').classList.add('hidden');
}

function enterApp() {
  document.getElementById('auth').classList.add('hidden');
  document.getElementById('dashboard').classList.remove('hidden');
  document.getElementById('welcomeText').textContent = `Bonjour ${currentUser.name} ${currentUser.role==='admin' ? '(Admin)' : ''}`;
  if (currentUser.role === 'admin') document.getElementById('adminPanel').classList.remove('hidden');
  renderCalendar();
  requestNotificationPermission();
}

// ==== CALENDRIER & NOTIFICATIONS ====
function renderCalendar() {
  const d = new Date();
  const y = d.getFullYear(), m = d.getMonth();
  document.getElementById('monthTitle').textContent = new Date(y,m,1).toLocaleDateString('fr-FR',{month:'long',year:'numeric'}).toUpperCase();

  const first = new Date(y,m,1).getDay();
  const days = new Date(y,m+1,0).getDate();
  const tbody = document.getElementById('calBody'); tbody.innerHTML = '';

  let day = 1, row = document.createElement('tr');
  for (let i = 0; i < 42; i++) {
    if (i>0 && i%7===0) { tbody.appendChild(row); row = document.createElement('tr'); }
    const cell = document.createElement('td');
    if (i >= first && day <= days) {
      const dateStr = `${y}-${String(m+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
      cell.innerHTML = `<div class="day-num">${day}</div><div id="d${dateStr}"></div>`;
      cell.onclick = () => { selectedDate = dateStr; document.getElementById('selDate').textContent = dateStr.split('-').reverse().join('/'); document.getElementById('quick').classList.remove('hidden'); };
      loadEvents(dateStr, cell.lastChild);
      day++;
    }
    row.appendChild(cell);
  }
  tbody.appendChild(row);
}

function loadEvents(date, container) {
  container.innerHTML = '';
  const dispos = db.get('dispos') || [];
  const events = db.get('events') || [];

  events.filter(e=>e.date===date).forEach(e => {
    const div = document.createElement('div'); div.className='event official'; div.textContent = e.name;
    container.appendChild(div);
  });

  dispos.filter(d=>d.date===date).forEach(d => {
    const div = document.createElement('div');
    div.className = `event ${d.email===currentUser.email ? 'me' : 'other'}`;
    div.innerHTML = `${d.time||''} ${d.desc} ${d.email===currentUser.email || currentUser.role==='admin' ? '<span class="del" onclick="delDispo(\''+d.id+'\');event.stopPropagation()">×</span>' : ''}`;
    container.appendChild(div);
  });
}

function saveDispo() {
  const time = document.getElementById('qTime').value;
  const desc = document.getElementById('qDesc').value.trim();
  if (!desc) return alert("Description obligatoire");
  const dispos = db.get('dispos') || [];
  const newId = Date.now();
  dispos.push({id:newId, email: currentUser.email, date:selectedDate, time, desc});
  db.set('dispos', dispos);

  // NOTIFICATION PUSH À TOUT LE MONDE
  sendNotification("Nouvelle dispo", `${currentUser.name} est dispo le ${selectedDate.split('-').reverse().join('/')} : ${desc}`);

  document.getElementById('quick').classList.add('hidden');
  renderCalendar();
}

function delDispo(id) {
  if(confirm('Supprimer ?')) {
    let dispos = db.get('dispos')||[];
    dispos = dispos.filter(d=>d.id!=id);
    db.set('dispos', dispos);
    renderCalendar();
  }
}

function addOfficialEvent() {
  const name = document.getElementById('eName').value.trim();
  const date = document.getElementById('eDate').value;
  const lieu = document.getElementById('eLieu').value.trim();
  if (!name || !date) return alert("Nom et date obligatoires");

  const events = db.get('events') || [];
  events.push({name, date, lieu});
  db.set('events', events);

  // NOTIFICATION PUSH À TOUT LE MONDE
  sendNotification("Nouvel événement", `${name} le ${date.split('-').reverse().join('/')} à ${lieu}`);

  renderCalendar();
}
function hideQuick(){ document.getElementById('quick').classList.add('hidden'); }

// Lancement
if (db.get('users') === null) {
  // Premier admin automatique
  const users = {};
  users["admin@rivecharente.fr"] = {name:"Admin", passHash:ADMIN_PASS_HASH, role:"admin"};
  db.set('users', users);
}
</script>
</body>
</html>
